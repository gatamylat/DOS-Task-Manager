<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TASK.SYS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="./manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    
    <title>TASK.SYS v1.0</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            image-rendering: pixelated;
            text-transform: uppercase;
        }
        
        :root {
            --green: #33ff33;
            --green-dim: #1a991a;
            --green-dark: #0d4d0d;
            --amber: #ffaa00;
            --red: #ff3333;
            --cyan: #00ffff;
            --magenta: #ff00ff;
            --bg: #000000;
            --bg-light: #0a0a0a;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            background: var(--bg);
            color: var(--green);
            min-height: 100vh;
            padding-top: var(--safe-top);
            font-size: 8px;
            line-height: 1.6;
        }
        
        /* CRT SCANLINES */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
        }
        
        /* CRT SCREEN CURVATURE */
        #mainApp {
            position: relative;
            overflow: hidden;
        }
        
        #mainApp::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                transparent 60%,
                rgba(0, 0, 0, 0.3) 90%,
                rgba(0, 0, 0, 0.6) 100%
            );
            pointer-events: none;
            z-index: 9998;
        }
        
        /* PHOSPHOR AFTERGLOW */
        .content, .task-item, .stat-box, .settings-item, .dos-box {
            transition: text-shadow 0.1s ease-out;
        }
        
        .task-item:active, .stat-box:active, .settings-item:active {
            text-shadow: 0 0 8px var(--green), 0 0 15px var(--green);
        }
        
        .phosphor-trail {
            animation: phosphor-fade 0.5s ease-out forwards;
        }
        
        @keyframes phosphor-fade {
            0% {
                text-shadow: 0 0 10px var(--green), 0 0 20px var(--green), 0 0 30px var(--green);
                opacity: 1;
            }
            100% {
                text-shadow: 0 0 2px var(--green);
                opacity: 0.8;
            }
        }
        
        /* STATIC NOISE OVERLAY */
        .static-noise {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0;
            pointer-events: none;
            z-index: 9997;
            mix-blend-mode: overlay;
        }
        
        .static-noise.active {
            animation: static-burst 0.3s steps(4) forwards;
        }
        
        @keyframes static-burst {
            0% { opacity: 0.4; }
            25% { opacity: 0.2; }
            50% { opacity: 0.5; }
            75% { opacity: 0.1; }
            100% { opacity: 0; }
        }
        
        /* BOSS MODE */
        .boss-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }
        
        .boss-overlay.active {
            display: flex;
        }
        
        .boss-title {
            font-size: 10px;
            color: var(--red);
            margin-bottom: 20px;
            animation: boss-pulse 1s infinite;
        }
        
        @keyframes boss-pulse {
            0%, 100% { text-shadow: 0 0 10px var(--red); }
            50% { text-shadow: 0 0 20px var(--red), 0 0 30px var(--red); }
        }
        
        .boss-task {
            font-size: 8px;
            color: var(--green);
            text-align: center;
            margin-bottom: 30px;
            max-width: 280px;
        }
        
        .boss-timer {
            font-family: 'Fira Code', monospace;
            font-size: 48px;
            color: var(--green);
            text-shadow: 0 0 20px var(--green);
            margin-bottom: 20px;
        }
        
        .boss-timer.warning {
            color: var(--amber);
            text-shadow: 0 0 20px var(--amber);
        }
        
        .boss-timer.danger {
            color: var(--red);
            text-shadow: 0 0 20px var(--red);
            animation: timer-shake 0.5s infinite;
        }
        
        @keyframes timer-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        .boss-progress {
            width: 100%;
            max-width: 280px;
            height: 20px;
            border: 2px solid var(--green);
            padding: 2px;
            margin-bottom: 20px;
        }
        
        .boss-progress-fill {
            height: 100%;
            background: var(--green);
            transition: width 1s linear;
        }
        
        .boss-progress-fill.warning {
            background: var(--amber);
        }
        
        .boss-progress-fill.danger {
            background: var(--red);
        }
        
        .boss-buttons {
            display: flex;
            gap: 12px;
        }
        
        .boss-btn {
            padding: 12px 20px;
            border: 2px solid var(--green);
            background: var(--bg);
            color: var(--green);
            font-family: 'Press Start 2P', monospace;
            font-size: 7px;
            cursor: pointer;
        }
        
        .boss-btn:active {
            background: var(--green);
            color: var(--bg);
        }
        
        .boss-btn.fail {
            border-color: var(--red);
            color: var(--red);
        }
        
        .boss-xp-bonus {
            font-size: 6px;
            color: var(--amber);
            margin-top: 12px;
        }
        
        /* BLINKING CURSOR */
        .cursor {
            display: inline-block;
            background: var(--green);
            width: 8px;
            height: 10px;
            animation: blink 1s step-end infinite;
            vertical-align: middle;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* BOOT SCREEN */
        .boot-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .boot-screen.hidden {
            display: none;
        }
        
        .boot-logo {
            font-family: 'Fira Code', monospace;
            font-size: 8px;
            font-weight: 700;
            color: var(--green);
            white-space: pre;
            line-height: 1.4;
            margin-bottom: 24px;
            text-align: center;
            text-shadow: 0 0 10px var(--green);
            animation: glitch 3s infinite;
            position: relative;
        }
        
        @keyframes glitch {
            0%, 92%, 100% {
                text-shadow: 0 0 10px var(--green);
                transform: translate(0);
            }
            93% {
                text-shadow: -2px 0 #ff0000, 2px 0 #00ffff, 0 0 10px var(--green);
                transform: translate(2px, 0);
            }
            94% {
                text-shadow: 2px 0 #ff0000, -2px 0 #00ffff, 0 0 10px var(--green);
                transform: translate(-2px, 0);
            }
            95% {
                text-shadow: 0 0 10px var(--green);
                transform: translate(0);
            }
            96% {
                text-shadow: -1px 0 #ff0000, 1px 0 #00ffff, 0 0 10px var(--green);
                transform: translate(1px, 1px);
            }
            97% {
                text-shadow: 0 0 10px var(--green);
                transform: translate(0);
            }
        }
        
        .boot-text {
            font-size: 7px;
            color: var(--green);
            text-align: center;
            min-height: 60px;
        }
        
        .boot-progress {
            margin-top: 16px;
            font-size: 6px;
            color: var(--green-dim);
        }
        
        /* MARQUEE */
        .marquee-container {
            background: var(--green-dark);
            overflow: hidden;
            padding: 4px 0;
            border-bottom: 1px solid var(--green-dim);
        }
        
        .marquee {
            display: inline-block;
            white-space: nowrap;
            font-size: 6px;
            color: var(--green);
            animation: marquee 20s linear infinite;
        }
        
        @keyframes marquee {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        
        /* HEADER */
        .header {
            background: var(--bg);
            padding: 8px 12px;
            border-bottom: 1px solid var(--green-dim);
        }
        
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 6px;
            color: var(--green-dim);
        }
        
        .header-title {
            font-size: 8px;
            color: var(--green);
            margin-bottom: 4px;
        }
        
        /* XP BAR - DOS STYLE */
        .xp-section {
            padding: 8px 12px;
            background: var(--bg);
            border-bottom: 1px solid var(--green-dim);
        }
        
        .xp-label {
            font-size: 6px;
            color: var(--green-dim);
            margin-bottom: 4px;
        }
        
        .xp-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 7px;
        }
        
        .xp-bar-ascii {
            flex: 1;
            color: var(--green);
            font-size: 8px;
            letter-spacing: -1px;
        }
        
        /* CONTENT */
        .content {
            padding: 12px;
            padding-bottom: calc(80px + var(--safe-bottom));
            min-height: calc(100vh - 200px);
        }
        
        /* DOS BOX FRAME */
        .dos-box {
            border: 1px solid var(--green-dim);
            margin-bottom: 12px;
        }
        
        .dos-box-title {
            background: var(--green-dim);
            color: var(--bg);
            padding: 4px 8px;
            font-size: 6px;
        }
        
        .dos-box-content {
            padding: 8px;
        }
        
        /* STATS ROW */
        .stats-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-box {
            flex: 1;
            border: 1px solid var(--green-dim);
            padding: 8px 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 12px;
            color: var(--green);
        }
        
        .stat-label {
            font-size: 5px;
            color: var(--green-dim);
            margin-top: 4px;
        }
        
        /* TASK LIST */
        .task-list {
            display: flex;
            flex-direction: column;
        }
        
        .task-item {
            border: 1px solid var(--green-dark);
            border-top: none;
            padding: 10px 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            background: var(--bg);
        }
        
        .task-item:first-child {
            border-top: 1px solid var(--green-dark);
        }
        
        .task-priority {
            font-size: 8px;
            width: 12px;
        }
        
        .task-priority.high { color: var(--red); }
        .task-priority.medium { color: var(--amber); }
        .task-priority.low { color: var(--green); }
        
        .task-item.completed {
            opacity: 0.4;
        }
        
        .task-item.completed .task-text {
            text-decoration: line-through;
        }
        
        .task-checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid var(--green-dim);
            background: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: var(--green);
            flex-shrink: 0;
        }
        
        .task-checkbox:active {
            background: var(--green-dark);
        }
        
        .task-content {
            flex: 1;
            min-width: 0;
        }
        
        .task-text {
            font-size: 7px;
            color: var(--green);
            word-break: break-word;
        }
        
        .task-meta {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            font-size: 5px;
            color: var(--green-dim);
        }
        
        .task-delete {
            background: transparent;
            border: none;
            color: var(--green-dim);
            font-family: inherit;
            font-size: 8px;
            cursor: pointer;
            padding: 4px;
        }
        
        .task-delete:active {
            color: var(--red);
        }
        
        /* ADD BUTTON */
        .add-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .add-btn {
            background: var(--bg);
            border: 1px solid var(--green);
            color: var(--green);
            font-family: inherit;
            font-size: 7px;
            padding: 6px 12px;
            cursor: pointer;
        }
        
        .add-btn:active {
            background: var(--green);
            color: var(--bg);
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--green-dim);
        }
        
        .empty-ascii {
            font-size: 5px;
            white-space: pre;
            margin-bottom: 12px;
        }
        
        /* SPINNER */
        .spinner {
            display: inline-block;
            width: 10px;
            text-align: center;
        }
        
        /* STATUS BAR */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--green-dim);
            color: var(--bg);
            font-size: 6px;
            padding: 4px 12px;
            display: flex;
            justify-content: space-between;
            z-index: 101;
        }
        
        /* NAV BAR */
        .nav-bar {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            background: var(--bg);
            border-top: 1px solid var(--green-dim);
            border-bottom: 1px solid var(--green-dim);
            display: flex;
            padding-bottom: var(--safe-bottom);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            padding: 8px 2px;
            text-align: center;
            color: var(--green-dim);
            cursor: pointer;
            font-size: 6px;
            border-right: 1px solid var(--green-dark);
        }
        
        .nav-item:last-child {
            border-right: none;
        }
        
        .nav-item.active {
            color: var(--green);
            background: var(--green-dark);
        }
        
        .nav-key {
            font-size: 7px;
            margin-bottom: 2px;
        }
        
        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg);
            border: 2px solid var(--green);
            width: 100%;
            max-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: var(--green);
            color: var(--bg);
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 7px;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--bg);
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            padding: 0 4px;
        }
        
        .modal-body {
            padding: 12px;
        }
        
        /* FORM */
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            font-size: 6px;
            color: var(--green-dim);
            margin-bottom: 4px;
            display: block;
        }
        
        .input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--green-dim);
            background: var(--bg);
            color: var(--green);
            font-family: inherit;
            font-size: 7px;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--green);
        }
        
        .input[type="date"] {
            color-scheme: dark;
        }
        
        .input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) sepia(1) saturate(5) hue-rotate(85deg);
            cursor: pointer;
        }
        
        .select-row {
            display: flex;
            gap: 4px;
        }
        
        .select-btn {
            flex: 1;
            padding: 8px 4px;
            border: 1px solid var(--green-dark);
            background: var(--bg);
            color: var(--green-dim);
            font-family: inherit;
            font-size: 6px;
            cursor: pointer;
            text-align: center;
        }
        
        .select-btn.active {
            border-color: var(--green);
            color: var(--green);
            background: var(--green-dark);
        }
        
        .select-btn[data-priority="high"].active {
            border-color: var(--red);
            color: var(--red);
        }
        
        .select-btn[data-priority="medium"].active {
            border-color: var(--amber);
            color: var(--amber);
        }
        
        .btn-submit {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--green);
            background: var(--bg);
            color: var(--green);
            font-family: inherit;
            font-size: 7px;
            cursor: pointer;
        }
        
        .btn-submit:active {
            background: var(--green);
            color: var(--bg);
        }
        
        /* TOAST */
        .toast {
            position: fixed;
            top: calc(40px + var(--safe-top));
            left: 12px;
            right: 12px;
            background: var(--bg);
            border: 1px solid var(--green);
            color: var(--green);
            padding: 8px 12px;
            font-size: 6px;
            z-index: 2000;
            transform: translateY(-100px);
            transition: transform 0.2s;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast.error {
            border-color: var(--red);
            color: var(--red);
        }
        
        /* LEVEL UP */
        .levelup-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .levelup-overlay.active {
            display: flex;
        }
        
        .levelup-ascii {
            font-size: 5px;
            color: var(--green);
            white-space: pre;
            margin-bottom: 16px;
            animation: blink 0.3s infinite;
        }
        
        .levelup-number {
            font-size: 32px;
            color: var(--green);
        }
        
        .levelup-text {
            font-size: 7px;
            color: var(--green-dim);
            margin-top: 12px;
        }
        
        /* SETTINGS */
        .settings-item {
            border: 1px solid var(--green-dark);
            border-top: none;
            padding: 12px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 6px;
        }
        
        .settings-item:first-child {
            border-top: 1px solid var(--green-dark);
        }
        
        .settings-item:active {
            background: var(--green-dark);
        }
        
        .settings-item .label {
            color: var(--green);
        }
        
        .settings-item .label.danger {
            color: var(--red);
        }
        
        .settings-item .arrow {
            color: var(--green-dim);
        }
        
        /* LOADING DOTS */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }
        
        /* TAGS */
        .tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        .tag {
            font-size: 5px;
            padding: 2px 6px;
            border: 1px solid var(--cyan);
            color: var(--cyan);
            border-radius: 2px;
            cursor: pointer;
        }
        
        .tag.selected {
            background: var(--cyan);
            color: var(--bg);
        }
        
        .tag-inline {
            font-size: 5px;
            color: var(--cyan);
            margin-left: 4px;
        }
        
        /* SUBTASKS */
        .subtasks-list {
            margin-top: 8px;
            padding-left: 8px;
            border-left: 1px solid var(--green-dark);
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            font-size: 6px;
        }
        
        .subtask-checkbox {
            width: 12px;
            height: 12px;
            border: 1px solid var(--green-dim);
            background: var(--bg);
            color: var(--green);
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .subtask-text {
            flex: 1;
        }
        
        .subtask-text.done {
            text-decoration: line-through;
            color: var(--green-dim);
        }
        
        .subtask-del {
            color: var(--red);
            cursor: pointer;
            font-size: 6px;
        }
        
        .subtask-progress {
            font-size: 5px;
            color: var(--green-dim);
            margin-top: 4px;
        }
        
        .add-subtask-row {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .add-subtask-row input {
            flex: 1;
            padding: 4px;
            font-size: 6px;
        }
        
        .add-subtask-row button {
            padding: 4px 8px;
            font-size: 6px;
        }
        
        /* ACHIEVEMENTS */
        .achievement-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 6000;
            padding: 20px;
        }
        
        .achievement-overlay.active {
            display: flex;
            animation: achievement-appear 0.5s ease-out;
        }
        
        @keyframes achievement-appear {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .achievement-icon {
            font-size: 48px;
            color: var(--amber);
            text-shadow: 0 0 20px var(--amber), 0 0 40px var(--amber);
            margin-bottom: 16px;
            animation: achievement-glow 1s infinite alternate;
        }
        
        @keyframes achievement-glow {
            0% { text-shadow: 0 0 20px var(--amber); }
            100% { text-shadow: 0 0 40px var(--amber), 0 0 60px var(--amber); }
        }
        
        .achievement-title {
            font-size: 10px;
            color: var(--amber);
            margin-bottom: 8px;
        }
        
        .achievement-name {
            font-size: 14px;
            color: var(--green);
            margin-bottom: 8px;
            text-shadow: 0 0 10px var(--green);
        }
        
        .achievement-desc {
            font-size: 7px;
            color: var(--green-dim);
            margin-bottom: 20px;
        }
        
        .achievement-continue {
            font-size: 6px;
            color: var(--green-dim);
            animation: blink 1s step-end infinite;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .achievement-card {
            padding: 8px;
            border: 1px solid var(--green-dark);
            text-align: center;
        }
        
        .achievement-card.unlocked {
            border-color: var(--amber);
        }
        
        .achievement-card.locked {
            opacity: 0.4;
        }
        
        .achievement-card-icon {
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .achievement-card.unlocked .achievement-card-icon {
            color: var(--amber);
        }
        
        .achievement-card-name {
            font-size: 5px;
            color: var(--green);
        }
        
        /* DEADLINE */
        .deadline-badge {
            font-size: 5px;
            color: var(--amber);
            margin-left: 4px;
        }
        
        .deadline-badge.urgent {
            color: var(--red);
            animation: blink 1s step-end infinite;
        }
    </style>
</head>
<body>
    <!-- BOOT SCREEN -->
    <div class="boot-screen" id="bootScreen">
        <div class="boot-logo" id="bootLogo"></div>
        <div class="boot-text" id="bootText"></div>
        <div class="boot-progress" id="bootProgress"></div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none;">
        <!-- MARQUEE -->
        <div class="marquee-container">
            <div class="marquee" id="marquee">
                ‚òÖ TASK.SYS V1.0 ‚òÖ STAY PRODUCTIVE ‚òÖ LEVEL UP YOUR LIFE ‚òÖ COMPLETE TASKS TO EARN XP ‚òÖ WAKE UP NEO... ‚òÖ THE MATRIX HAS YOU ‚òÖ FOLLOW THE WHITE RABBIT ‚òÖ
            </div>
        </div>
        
        <!-- HEADER -->
        <header class="header">
            <div class="header-title">C:\TASK.SYS><span class="cursor"></span></div>
            <div class="header-row">
                <span id="dateDisplay">--/--/----</span>
                <span><span class="spinner" id="clockSpinner">|</span> <span id="timeDisplay">--:--:--</span></span>
            </div>
        </header>
        
        <!-- XP BAR -->
        <div class="xp-section">
            <div class="xp-label">‚ïî‚ïê‚ïê EXPERIENCE ‚ïê‚ïê‚ïó</div>
            <div class="xp-row">
                <span>LV.<span id="levelNum">01</span></span>
                <span class="xp-bar-ascii" id="xpBarAscii">[‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]</span>
                <span id="xpText">000/100</span>
            </div>
        </div>
        
        <!-- CONTENT -->
        <main class="content" id="mainContent"></main>
        
        <!-- NAV BAR -->
        <nav class="nav-bar">
            <div class="nav-item active" onclick="App.go('tasks')" data-tab="tasks">
                <div class="nav-key">[F1]</div>
                <div>TASKS</div>
            </div>
            <div class="nav-item" onclick="App.go('plan')" data-tab="plan">
                <div class="nav-key">[F2]</div>
                <div>PLAN</div>
            </div>
            <div class="nav-item" onclick="App.go('sys')" data-tab="sys">
                <div class="nav-key">[F3]</div>
                <div>SYS</div>
            </div>
            <div class="nav-item" onclick="App.go('stats')" data-tab="stats">
                <div class="nav-key">[F4]</div>
                <div>STATS</div>
            </div>
        </nav>
        
        <!-- STATUS BAR -->
        <div class="status-bar">
            <span id="statusLeft">READY</span>
            <span id="statusRight">MEM: 640K OK</span>
        </div>
    </div>
    
    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay" onclick="App.closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="modalTitle">DIALOG</span>
                <button class="modal-close" onclick="App.closeModal()">[X]</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <!-- TOAST -->
    <div class="toast" id="toast"></div>
    
    <!-- LEVEL UP -->
    <div class="levelup-overlay" id="levelupOverlay" onclick="App.closeLevelUp()">
        <div class="levelup-ascii">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   ‚òÖ LEVEL UP!! ‚òÖ     ‚ïë
‚ïë                       ‚ïë
‚ïë  POWER INCREASED!     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        </div>
        <div class="levelup-number" id="levelupNum">02</div>
        <div class="levelup-text">PRESS ANY KEY TO CONTINUE...</div>
    </div>
    
    <!-- STATIC NOISE -->
    <div class="static-noise" id="staticNoise"></div>
    
    <!-- BOSS MODE -->
    <div class="boss-overlay" id="bossOverlay">
        <div class="boss-title">‚ò† BOSS BATTLE ‚ò†</div>
        <div class="boss-task" id="bossTask">COMPLETE THE TASK BEFORE TIME RUNS OUT!</div>
        <div class="boss-timer" id="bossTimer">25:00</div>
        <div class="boss-progress">
            <div class="boss-progress-fill" id="bossProgressFill" style="width: 100%"></div>
        </div>
        <div class="boss-xp-bonus">‚òÖ BONUS: X2 XP ‚òÖ</div>
        <div class="boss-buttons">
            <button class="boss-btn fail" onclick="App.bossFail()">[ESC] GIVE UP</button>
            <button class="boss-btn" onclick="App.bossWin()">[ENTER] COMPLETE</button>
        </div>
    </div>
    
    <!-- ACHIEVEMENT UNLOCK -->
    <div class="achievement-overlay" id="achievementOverlay" onclick="App.closeAchievement()">
        <div class="achievement-icon" id="achievementIcon">‚òÖ</div>
        <div class="achievement-title">ACHIEVEMENT UNLOCKED!</div>
        <div class="achievement-name" id="achievementName">FIRST BLOOD</div>
        <div class="achievement-desc" id="achievementDesc">Complete your first task</div>
        <div class="achievement-continue">PRESS ANY KEY TO CONTINUE...</div>
    </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TASK.SYS V1.0 - DOS-STYLE TASK MANAGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const BOOT_LOGO = `
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù
   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù 
   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó 
   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó
   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
        ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`;

const BOOT_MESSAGES = [
    'TASK.SYS VERSION 1.0',
    'COPYRIGHT (C) 2025',
    '',
    'INITIALIZING SYSTEM...',
    'LOADING KERNEL...',
    'CHECKING MEMORY... 640K OK',
    'LOADING DATABASE MODULE...',
    'STARTING XP ENGINE...',
    'MOUNTING TASK DRIVE...',
    '',
    'SYSTEM READY.',
    '',
    'PRESS ANY KEY TO CONTINUE...'
];

class TaskSys {
    constructor() {
        this.db = null;
        this.currentTab = 'tasks';
        this.user = { 
            level: 1, 
            xp: 0, 
            total: 0, 
            streak: 0, 
            lastDate: null,
            achievements: [],
            bossWins: 0
        };
        this.XP_MAX = 100;
        this.selectedPriority = 'medium';
        this.selectedXP = 10;
        this.selectedTags = [];
        this.spinnerFrames = ['|', '/', '-', '\\'];
        this.spinnerIndex = 0;
        
        // Audio context for 8-bit sounds
        this.audioCtx = null;
        
        // Boss mode
        this.bossActive = false;
        this.bossTask = null;
        this.bossTimer = null;
        this.bossTimeLeft = 0;
        this.bossDuration = 0;
        this.selectedBossTime = 30;
        
        // Achievements definitions
        this.ACHIEVEMENTS = [
            { id: 'first_blood', name: 'FIRST BLOOD', desc: 'Complete your first task', icon: '‚Ä†', check: (u) => u.total >= 1 },
            { id: 'getting_started', name: 'GETTING STARTED', desc: 'Complete 10 tasks', icon: '‚òÖ', check: (u) => u.total >= 10 },
            { id: 'productive', name: 'PRODUCTIVE', desc: 'Complete 50 tasks', icon: '‚óÜ', check: (u) => u.total >= 50 },
            { id: 'task_master', name: 'TASK MASTER', desc: 'Complete 100 tasks', icon: '‚ô¶', check: (u) => u.total >= 100 },
            { id: 'streak_3', name: 'ON FIRE', desc: '3 day streak', icon: '‚ô®', check: (u) => u.streak >= 3 },
            { id: 'streak_7', name: 'UNSTOPPABLE', desc: '7 day streak', icon: '‚òÄ', check: (u) => u.streak >= 7 },
            { id: 'streak_30', name: 'LEGENDARY', desc: '30 day streak', icon: '‚ôõ', check: (u) => u.streak >= 30 },
            { id: 'level_5', name: 'LEVELING UP', desc: 'Reach level 5', icon: '‚ñ≤', check: (u) => u.level >= 5 },
            { id: 'level_10', name: 'VETERAN', desc: 'Reach level 10', icon: '‚óÑ‚ñ∫', check: (u) => u.level >= 10 },
            { id: 'boss_slayer', name: 'BOSS SLAYER', desc: 'Win 5 boss battles', icon: '‚ò†', check: (u) => u.bossWins >= 5 },
            { id: 'boss_hunter', name: 'BOSS HUNTER', desc: 'Win 20 boss battles', icon: '‚öî', check: (u) => u.bossWins >= 20 }
        ];
        
        // Deadline check interval
        this.deadlineInterval = null;
        
        // Tag filter
        this.filterTag = null;
        
        this.dom = {
            bootScreen: document.getElementById('bootScreen'),
            bootLogo: document.getElementById('bootLogo'),
            bootText: document.getElementById('bootText'),
            bootProgress: document.getElementById('bootProgress'),
            mainApp: document.getElementById('mainApp'),
            content: document.getElementById('mainContent'),
            levelNum: document.getElementById('levelNum'),
            xpBarAscii: document.getElementById('xpBarAscii'),
            xpText: document.getElementById('xpText'),
            dateDisplay: document.getElementById('dateDisplay'),
            timeDisplay: document.getElementById('timeDisplay'),
            clockSpinner: document.getElementById('clockSpinner'),
            modal: document.getElementById('modalOverlay'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            toast: document.getElementById('toast'),
            levelup: document.getElementById('levelupOverlay'),
            levelupNum: document.getElementById('levelupNum'),
            statusLeft: document.getElementById('statusLeft'),
            statusRight: document.getElementById('statusRight'),
            staticNoise: document.getElementById('staticNoise'),
            bossOverlay: document.getElementById('bossOverlay'),
            bossTask: document.getElementById('bossTask'),
            bossTimerEl: document.getElementById('bossTimer'),
            bossProgressFill: document.getElementById('bossProgressFill'),
            achievementOverlay: document.getElementById('achievementOverlay'),
            achievementIcon: document.getElementById('achievementIcon'),
            achievementName: document.getElementById('achievementName'),
            achievementDesc: document.getElementById('achievementDesc')
        };
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOOT SEQUENCE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async boot() {
        // Show logo with typewriter effect
        await this.typewriter(this.dom.bootLogo, BOOT_LOGO, 2);
        
        // Show boot messages
        for (let i = 0; i < BOOT_MESSAGES.length; i++) {
            const msg = BOOT_MESSAGES[i];
            await this.typewriter(this.dom.bootText, msg + '\n', 30, true);
            
            // Update progress bar
            const progress = Math.floor((i / BOOT_MESSAGES.length) * 100);
            const filled = Math.floor(progress / 10);
            const bar = '[' + '‚ñà'.repeat(filled) + '‚ñë'.repeat(10 - filled) + '] ' + progress + '%';
            this.dom.bootProgress.textContent = bar;
            
            await this.sleep(100);
        }
        
        // Wait for click/key
        await new Promise(resolve => {
            const handler = () => {
                document.removeEventListener('click', handler);
                document.removeEventListener('keydown', handler);
                resolve();
            };
            document.addEventListener('click', handler);
            document.addEventListener('keydown', handler);
        });
        
        // Hide boot, show app
        this.dom.bootScreen.classList.add('hidden');
        this.dom.mainApp.style.display = 'block';
        
        // Start main app
        await this.init();
    }
    
    async typewriter(element, text, speed = 50, append = false) {
        const chars = text.split('');
        for (const char of chars) {
            if (append) {
                element.textContent += char;
            } else {
                element.textContent = (element.textContent || '') + char;
            }
            await this.sleep(speed);
        }
    }
    
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async init() {
        this.setStatus('INITIALIZING...');
        
        await this.initDB();
        await this.loadUser();
        this.updateClock();
        this.startSpinner();
        this.updateXP();
        await this.checkStreak();
        this.render();
        
        // Request notification permission
        this.requestNotificationPermission();
        
        // Start deadline checker (every minute)
        this.startDeadlineChecker();
        
        this.setStatus('READY', 'TASKS: ' + (await this.dbAll('tasks')).length);
    }
    
    async requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            await Notification.requestPermission();
        }
    }
    
    startDeadlineChecker() {
        // Check every minute
        this.deadlineInterval = setInterval(() => this.checkDeadlines(), 60000);
        // Initial check
        this.checkDeadlines();
    }
    
    async checkDeadlines() {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        
        const tasks = await this.dbAll('tasks');
        const now = new Date();
        
        tasks.forEach(task => {
            if (task.done || !task.deadline) return;
            
            const deadline = new Date(task.deadline);
            const diff = deadline - now;
            const minutes = Math.floor(diff / 60000);
            
            // Notify 15 minutes before
            if (minutes > 0 && minutes <= 15 && !task.notified15) {
                this.showNotification('‚ö† DEADLINE APPROACHING', `"${task.text}" in ${minutes} min!`);
                task.notified15 = true;
                this.dbPut('tasks', task);
            }
            
            // Notify when overdue
            if (minutes < 0 && minutes > -5 && !task.notifiedOverdue) {
                this.showNotification('üî¥ DEADLINE PASSED', `"${task.text}" is overdue!`);
                task.notifiedOverdue = true;
                this.dbPut('tasks', task);
            }
        });
    }
    
    showNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, { body, icon: './icons/icon-192.png' });
        }
    }
    
    startSpinner() {
        setInterval(() => {
            this.spinnerIndex = (this.spinnerIndex + 1) % this.spinnerFrames.length;
            this.dom.clockSpinner.textContent = this.spinnerFrames[this.spinnerIndex];
            this.updateClock();
        }, 250);
    }
    
    setStatus(left, right) {
        this.dom.statusLeft.textContent = left || 'READY';
        if (right !== undefined) this.dom.statusRight.textContent = right;
    }
    
    async initDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('TaskSysDB', 2);
            req.onerror = () => reject(req.error);
            req.onsuccess = () => { this.db = req.result; resolve(); };
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('tasks')) {
                    db.createObjectStore('tasks', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('user')) {
                    db.createObjectStore('user', { keyPath: 'key' });
                }
                if (!db.objectStoreNames.contains('tags')) {
                    db.createObjectStore('tags', { keyPath: 'id' });
                }
            };
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DATABASE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async dbPut(store, data) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            tx.objectStore(store).put(data);
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }
    
    async dbGet(store, key) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readonly');
            const req = tx.objectStore(store).get(key);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }
    
    async dbAll(store) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readonly');
            const req = tx.objectStore(store).getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => reject(req.error);
        });
    }
    
    async dbDel(store, key) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            tx.objectStore(store).delete(key);
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }
    
    async dbClear(store) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            tx.objectStore(store).clear();
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // USER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async loadUser() {
        const data = await this.dbGet('user', 'profile');
        if (data) {
            this.user = data.value;
            // Initialize new fields for existing users
            if (!this.user.achievements) this.user.achievements = [];
            if (!this.user.bossWins) this.user.bossWins = 0;
        }
        else await this.saveUser();
    }
    
    async saveUser() {
        await this.dbPut('user', { key: 'profile', value: this.user });
    }
    
    async addXP(amt) {
        this.user.xp += amt;
        while (this.user.xp >= this.XP_MAX) {
            this.user.xp -= this.XP_MAX;
            this.user.level++;
            this.showLevelUp(this.user.level);
            await this.checkAchievements();
        }
        await this.saveUser();
        this.updateXP();
    }
    
    updateXP() {
        const filled = Math.floor((this.user.xp / this.XP_MAX) * 10);
        const bar = '[' + '‚ñà'.repeat(filled) + '‚ñë'.repeat(10 - filled) + ']';
        this.dom.xpBarAscii.textContent = bar;
        this.dom.xpText.textContent = String(this.user.xp).padStart(3, '0') + '/' + this.XP_MAX;
        this.dom.levelNum.textContent = String(this.user.level).padStart(2, '0');
    }
    
    updateClock() {
        const now = new Date();
        this.dom.dateDisplay.textContent = now.toLocaleDateString('ru-RU');
        this.dom.timeDisplay.textContent = now.toLocaleTimeString('ru-RU');
    }
    
    async checkStreak() {
        const today = this.today();
        const last = this.user.lastDate;
        if (last) {
            const y = new Date();
            y.setDate(y.getDate() - 1);
            const yStr = y.toISOString().split('T')[0];
            if (last !== today) {
                this.user.streak = (last === yStr) ? this.user.streak + 1 : 1;
            }
        } else {
            this.user.streak = 1;
        }
        this.user.lastDate = today;
        await this.saveUser();
        await this.checkAchievements();
    }
    
    today() {
        return new Date().toISOString().split('T')[0];
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NAVIGATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    go(tab) {
        if (this.currentTab !== tab) {
            this.showStaticNoise();
        }
        this.currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(n => {
            n.classList.toggle('active', n.dataset.tab === tab);
        });
        this.render();
    }
    
    render() {
        this.setStatus('LOADING<span class="loading-dots"></span>');
        if (this.currentTab === 'tasks') this.renderTasks();
        else if (this.currentTab === 'plan') this.renderPlan();
        else if (this.currentTab === 'sys') this.renderSys();
        else if (this.currentTab === 'stats') this.renderStats();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TASKS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderTasks() {
        let tasks = await this.getTodayTasks();
        let overdue = await this.getOverdueTasks();
        const allTags = await this.getTags();
        
        // Filter by tag if selected
        if (this.filterTag) {
            tasks = tasks.filter(t => t.tags && t.tags.includes(this.filterTag));
            overdue = overdue.filter(t => t.tags && t.tags.includes(this.filterTag));
        }
        
        const done = tasks.filter(t => t.done).length;
        const todo = tasks.filter(t => !t.done).length;
        
        const overdueTasksHTML = await Promise.all(overdue.map(t => this.taskHTML(t, true, allTags)));
        const todayTasksHTML = await Promise.all(tasks.map(t => this.taskHTML(t, false, allTags)));
        
        // Tag filters
        const tagFiltersHTML = allTags.length > 0 ? `
            <div class="dos-box" style="padding: 8px; margin-bottom: 8px;">
                <div style="font-size: 5px; color: var(--green-dim); margin-bottom: 6px;">FILTER BY TAG:</div>
                <div class="tags-row">
                    <span class="tag ${!this.filterTag ? 'selected' : ''}" 
                          style="border-color: var(--green); color: ${!this.filterTag ? 'var(--bg)' : 'var(--green)'}; background: ${!this.filterTag ? 'var(--green)' : 'transparent'};"
                          onclick="App.setTagFilter(null)">ALL</span>
                    ${allTags.map(t => `
                        <span class="tag ${this.filterTag === t.id ? 'selected' : ''}" 
                              style="border-color: ${t.color}; color: ${this.filterTag === t.id ? 'var(--bg)' : t.color}; background: ${this.filterTag === t.id ? t.color : 'transparent'};"
                              onclick="App.setTagFilter('${t.id}')">#${t.name}</span>
                    `).join('')}
                </div>
            </div>
        ` : '';
        
        const overdueHTML = overdue.length > 0 ? `
            <div class="dos-box" style="border-color: var(--red);">
                <div class="dos-box-title" style="background: var(--red); color: var(--bg);">‚ïî‚ïê‚ïê ‚ö† OVERDUE ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div class="task-list">
                        ${overdueTasksHTML.join('')}
                    </div>
                    <div style="margin-top: 8px; font-size: 5px; color: var(--red);">
                        ${overdue.length} OVERDUE TASK(S)!
                    </div>
                </div>
            </div>
        ` : '';
        
        const filterLabel = this.filterTag ? ` (FILTERED)` : '';
        
        this.dom.content.innerHTML = `
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value">${todo}</div>
                    <div class="stat-label">TODO</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${done}</div>
                    <div class="stat-label">DONE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" style="${overdue.length > 0 ? 'color: var(--red);' : ''}">${overdue.length}</div>
                    <div class="stat-label">OVERDUE</div>
                </div>
            </div>
            
            ${tagFiltersHTML}
            
            ${overdueHTML}
            
            <div class="dos-box">
                <div class="dos-box-title">‚ïî‚ïê‚ïê TODAY'S TASKS${filterLabel} ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div class="add-row">
                        <span style="font-size: 6px; color: var(--green-dim);">DIR C:\\TASKS\\*.*</span>
                        <button class="add-btn" onclick="App.addTask()">[+] NEW</button>
                    </div>
                    
                    ${tasks.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-ascii">
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë   NO FILES FOUND  ‚ïë
    ‚ïë                   ‚ïë
    ‚ïë   0 FILE(S)       ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                            </div>
                            <div>${this.filterTag ? 'NO TASKS WITH THIS TAG' : 'DIRECTORY IS EMPTY'}</div>
                        </div>
                    ` : `
                        <div class="task-list">
                            ${todayTasksHTML.join('')}
                        </div>
                        <div style="margin-top: 8px; font-size: 5px; color: var(--green-dim);">
                            ${tasks.length} FILE(S) - ${done} COMPLETED
                        </div>
                    `}
                </div>
            </div>
        `;
        
        this.setStatus('READY', 'TASKS: ' + (tasks.length + overdue.length));
    }
    
    setTagFilter(tagId) {
        this.filterTag = tagId;
        this.render();
    }
    
    taskHTML(t, isOverdue, allTags) {
        const priorityChar = t.priority === 'high' ? '!' : t.priority === 'medium' ? '*' : '-';
        const bossBtn = !t.done ? `<button class="task-delete" style="color: var(--amber);" onclick="event.stopPropagation(); App.initBoss('${t.id}')">[‚ò†]</button>` : '';
        const overdueStyle = isOverdue ? 'border-color: var(--red);' : '';
        const dateLabel = isOverdue ? `<span style="color: var(--red);">${t.date}</span>` : '';
        
        // Tags
        let tagsHTML = '';
        if (t.tags && t.tags.length > 0 && allTags) {
            tagsHTML = t.tags.map(tagId => {
                const tag = allTags.find(tg => tg.id === tagId);
                return tag ? `<span class="tag-inline" style="color: ${tag.color};">#${tag.name}</span>` : '';
            }).join('');
        }
        
        // Deadline
        let deadlineHTML = '';
        if (t.deadline && !t.done) {
            const deadline = new Date(t.deadline);
            const now = new Date();
            const diff = deadline - now;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 0) {
                deadlineHTML = `<span class="deadline-badge urgent">‚ö† OVERDUE</span>`;
            } else if (minutes <= 60) {
                deadlineHTML = `<span class="deadline-badge urgent">‚è∞ ${minutes}M LEFT</span>`;
            } else {
                const time = t.deadline.split('T')[1];
                deadlineHTML = `<span class="deadline-badge">‚è∞ ${time}</span>`;
            }
        }
        
        // Subtasks progress
        let subtasksHTML = '';
        if (t.subtasks && t.subtasks.length > 0) {
            const done = t.subtasks.filter(s => s.done).length;
            const total = t.subtasks.length;
            subtasksHTML = `<span style="color: var(--cyan);">[${done}/${total}]</span>`;
        }
        
        return `
            <div class="task-item ${t.done ? 'completed' : ''}" style="${overdueStyle}">
                <div class="task-priority ${t.priority}">${priorityChar}</div>
                <button class="task-checkbox" onclick="App.toggle('${t.id}')">
                    ${t.done ? 'X' : ' '}
                </button>
                <div class="task-content" onclick="App.editTask('${t.id}')">
                    <div class="task-text">${this.esc(t.text)}${tagsHTML}</div>
                    <div class="task-meta">
                        <span>+${t.xp}XP</span>
                        ${subtasksHTML}
                        ${deadlineHTML}
                        ${dateLabel}
                    </div>
                </div>
                ${bossBtn}
                <button class="task-delete" onclick="App.delTask('${t.id}')">[DEL]</button>
            </div>
        `;
    }
    
    async initBoss(id) {
        const task = await this.dbGet('tasks', id);
        if (task) this.showBossModal(task);
    }
    
    async getOverdueTasks() {
        const all = await this.dbAll('tasks');
        const today = this.today();
        return all.filter(t => t.date < today && !t.done).sort((a, b) => {
            // Oldest first
            return a.date.localeCompare(b.date);
        });
    }
    
    async getTodayTasks() {
        const all = await this.dbAll('tasks');
        const today = this.today();
        return all.filter(t => t.date === today).sort((a, b) => {
            if (a.done !== b.done) return a.done ? 1 : -1;
            const ord = { high: 0, medium: 1, low: 2 };
            return ord[a.priority] - ord[b.priority];
        });
    }
    
    async addTask() {
        const tagsHTML = await this.renderTagSelector([]);
        
        this.showModal('NEW TASK', `
            <div class="form-group">
                <label class="form-label">DESCRIPTION:</label>
                <input type="text" class="input" id="taskInput" placeholder="ENTER TASK...">
            </div>
            
            <div class="form-group">
                <label class="form-label">DEADLINE (OPTIONAL):</label>
                <input type="time" class="input" id="taskDeadline" placeholder="HH:MM">
            </div>
            
            <div class="form-group">
                <label class="form-label">TAGS:</label>
                <div class="tags-row" id="tagsSelector">${tagsHTML}</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn active" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn active" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn" data-xp="20" onclick="App.setXP(20)">+20</button>
                    <button class="select-btn" data-xp="50" onclick="App.setXP(50)">+50</button>
                </div>
            </div>
            
            <button class="btn-submit" onclick="App.saveTask()">[ENTER] SAVE</button>
        `);
        
        this.selectedPriority = 'medium';
        this.selectedXP = 10;
        this.selectedTags = [];
        setTimeout(() => document.getElementById('taskInput').focus(), 100);
    }
    
    setPriority(p) {
        this.selectedPriority = p;
        document.querySelectorAll('[data-priority]').forEach(b => {
            b.classList.toggle('active', b.dataset.priority === p);
        });
    }
    
    setXP(x) {
        this.selectedXP = x;
        document.querySelectorAll('[data-xp]').forEach(b => {
            b.classList.toggle('active', parseInt(b.dataset.xp) === x);
        });
    }
    
    async saveTask() {
        const text = document.getElementById('taskInput').value.trim();
        if (!text) { this.toast('ERROR: EMPTY INPUT', 'error'); return; }
        
        const deadlineTime = document.getElementById('taskDeadline').value;
        let deadline = null;
        if (deadlineTime) {
            deadline = this.today() + 'T' + deadlineTime;
        }
        
        const task = {
            id: 't_' + Date.now(),
            text: text,
            priority: this.selectedPriority,
            xp: this.selectedXP,
            done: false,
            date: this.today(),
            created: new Date().toISOString(),
            tags: [...this.selectedTags],
            deadline: deadline,
            subtasks: []
        };
        
        await this.dbPut('tasks', task);
        this.closeModal();
        this.toast('TASK CREATED SUCCESSFULLY');
        this.render();
    }
    
    async toggle(id) {
        const task = await this.dbGet('tasks', id);
        if (!task) return;
        
        task.done = !task.done;
        await this.dbPut('tasks', task);
        
        if (task.done) {
            this.user.total++;
            await this.addXP(task.xp);
            this.toast('TASK COMPLETE! +' + task.xp + ' XP');
            await this.checkAchievements();
        }
        
        this.render();
    }
    
    async delTask(id) {
        await this.dbDel('tasks', id);
        this.toast('TASK DELETED');
        this.render();
    }
    
    async editTask(id) {
        const task = await this.dbGet('tasks', id);
        if (!task) return;
        
        const tagsHTML = await this.renderTagSelector(task.tags || []);
        const subtasks = task.subtasks || [];
        const subtasksListHTML = subtasks.map((s, i) => `
            <div class="subtask-item">
                <button class="subtask-checkbox" onclick="App.toggleSubtask('${task.id}', ${i}); App.editTask('${task.id}');">
                    ${s.done ? 'X' : ' '}
                </button>
                <span class="subtask-text ${s.done ? 'done' : ''}">${this.esc(s.text)}</span>
                <span class="subtask-del" onclick="App.delSubtask('${task.id}', ${i}); App.editTask('${task.id}');">[X]</span>
            </div>
        `).join('');
        
        const currentDeadline = task.deadline ? task.deadline.split('T')[1] || '' : '';
        
        this.showModal('EDIT TASK', `
            <div class="form-group">
                <label class="form-label">DESCRIPTION:</label>
                <input type="text" class="input" id="editInput" value="${this.esc(task.text)}">
            </div>
            
            <div class="form-group">
                <label class="form-label">DEADLINE (OPTIONAL):</label>
                <input type="time" class="input" id="editDeadline" value="${currentDeadline}">
            </div>
            
            <div class="form-group">
                <label class="form-label">TAGS:</label>
                <div class="tags-row" id="tagsSelector">${tagsHTML}</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">SUBTASKS:</label>
                ${subtasks.length > 0 ? `
                    <div class="subtasks-list" style="border: none; padding: 0;">
                        ${subtasksListHTML}
                    </div>
                ` : '<div style="font-size: 6px; color: var(--green-dim);">NO SUBTASKS</div>'}
                <div class="add-subtask-row">
                    <input type="text" class="input" id="subtaskInput-${task.id}" placeholder="ADD SUBTASK...">
                    <button class="btn-submit" style="width: auto; padding: 4px 12px;" onclick="App.addSubtask('${task.id}'); App.editTask('${task.id}');">[+]</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn ${task.priority === 'low' ? 'active' : ''}" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn ${task.priority === 'medium' ? 'active' : ''}" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn ${task.priority === 'high' ? 'active' : ''}" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn ${task.xp === 5 ? 'active' : ''}" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn ${task.xp === 10 ? 'active' : ''}" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn ${task.xp === 20 ? 'active' : ''}" data-xp="20" onclick="App.setXP(20)">+20</button>
                    <button class="select-btn ${task.xp === 50 ? 'active' : ''}" data-xp="50" onclick="App.setXP(50)">+50</button>
                </div>
            </div>
            
            <button class="btn-submit" onclick="App.updateTask('${task.id}')">[ENTER] UPDATE</button>
        `);
        
        this.selectedPriority = task.priority;
        this.selectedXP = task.xp;
        this.selectedTags = [...(task.tags || [])];
    }
    
    async updateTask(id) {
        const task = await this.dbGet('tasks', id);
        if (!task) return;
        
        const deadlineTime = document.getElementById('editDeadline').value;
        let deadline = null;
        if (deadlineTime) {
            deadline = task.date + 'T' + deadlineTime;
        }
        
        task.text = document.getElementById('editInput').value.trim();
        task.priority = this.selectedPriority;
        task.xp = this.selectedXP;
        task.tags = [...this.selectedTags];
        task.deadline = deadline;
        // Reset notification flags if deadline changed
        task.notified15 = false;
        task.notifiedOverdue = false;
        
        await this.dbPut('tasks', task);
        this.closeModal();
        this.toast('TASK UPDATED');
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PLAN - FUTURE TASKS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderPlan() {
        let planned = await this.getPlannedTasks();
        const allTags = await this.getTags();
        const tomorrow = this.getTomorrow();
        const weekEnd = this.getWeekEnd();
        
        // Filter by tag if selected
        if (this.filterTag) {
            planned = planned.filter(t => t.tags && t.tags.includes(this.filterTag));
        }
        
        // Group tasks
        const tomorrowTasks = planned.filter(t => t.date === tomorrow);
        const weekTasks = planned.filter(t => t.date > tomorrow && t.date <= weekEnd);
        const laterTasks = planned.filter(t => t.date > weekEnd);
        
        // Tag filters
        const tagFiltersHTML = allTags.length > 0 ? `
            <div class="dos-box" style="padding: 8px; margin-bottom: 8px;">
                <div style="font-size: 5px; color: var(--green-dim); margin-bottom: 6px;">FILTER BY TAG:</div>
                <div class="tags-row">
                    <span class="tag ${!this.filterTag ? 'selected' : ''}" 
                          style="border-color: var(--green); color: ${!this.filterTag ? 'var(--bg)' : 'var(--green)'}; background: ${!this.filterTag ? 'var(--green)' : 'transparent'};"
                          onclick="App.setTagFilter(null)">ALL</span>
                    ${allTags.map(t => `
                        <span class="tag ${this.filterTag === t.id ? 'selected' : ''}" 
                              style="border-color: ${t.color}; color: ${this.filterTag === t.id ? 'var(--bg)' : t.color}; background: ${this.filterTag === t.id ? t.color : 'transparent'};"
                              onclick="App.setTagFilter('${t.id}')">#${t.name}</span>
                    `).join('')}
                </div>
            </div>
        ` : '';
        
        const filterLabel = this.filterTag ? ` (FILTERED)` : '';
        
        this.dom.content.innerHTML = `
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value">${tomorrowTasks.length}</div>
                    <div class="stat-label">TOMORROW</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${weekTasks.length}</div>
                    <div class="stat-label">THIS WEEK</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${laterTasks.length}</div>
                    <div class="stat-label">LATER</div>
                </div>
            </div>
            
            ${tagFiltersHTML}
            
            <div class="dos-box">
                <div class="dos-box-title">‚ïî‚ïê‚ïê PLANNED TASKS${filterLabel} ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div class="add-row">
                        <span style="font-size: 6px; color: var(--green-dim);">DIR C:\\PLAN\\*.*</span>
                        <button class="add-btn" onclick="App.addPlanTask()">[+] SCHEDULE</button>
                    </div>
                    
                    ${planned.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-ascii">
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë   NO PLANS YET    ‚ïë
    ‚ïë                   ‚ïë
    ‚ïë   SCHEDULE AHEAD! ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                            </div>
                            <div>${this.filterTag ? 'NO PLANS WITH THIS TAG' : 'PLAN YOUR FUTURE'}</div>
                        </div>
                    ` : `
                        ${tomorrowTasks.length > 0 ? `
                            <div style="font-size: 6px; color: var(--amber); margin: 8px 0 4px; border-bottom: 1px solid var(--green-dark); padding-bottom: 4px;">
                                ‚ñ∫ TOMORROW (${this.formatDate(tomorrow)})
                            </div>
                            <div class="task-list">
                                ${tomorrowTasks.map(t => this.planTaskHTML(t, allTags)).join('')}
                            </div>
                        ` : ''}
                        
                        ${weekTasks.length > 0 ? `
                            <div style="font-size: 6px; color: var(--cyan); margin: 8px 0 4px; border-bottom: 1px solid var(--green-dark); padding-bottom: 4px;">
                                ‚ñ∫ THIS WEEK
                            </div>
                            <div class="task-list">
                                ${weekTasks.map(t => this.planTaskHTML(t, allTags)).join('')}
                            </div>
                        ` : ''}
                        
                        ${laterTasks.length > 0 ? `
                            <div style="font-size: 6px; color: var(--green-dim); margin: 8px 0 4px; border-bottom: 1px solid var(--green-dark); padding-bottom: 4px;">
                                ‚ñ∫ LATER
                            </div>
                            <div class="task-list">
                                ${laterTasks.map(t => this.planTaskHTML(t, allTags)).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 8px; font-size: 5px; color: var(--green-dim);">
                            ${planned.length} SCHEDULED TASK(S)
                        </div>
                    `}
                </div>
            </div>
        `;
        
        this.setStatus('READY', 'PLANNED: ' + planned.length);
    }
    
    planTaskHTML(t, allTags) {
        const priorityChar = t.priority === 'high' ? '!' : t.priority === 'medium' ? '*' : '-';
        const daysUntil = this.daysUntil(t.date);
        const dateLabel = daysUntil === 1 ? 'TOMORROW' : 
                         daysUntil <= 7 ? this.formatDate(t.date) : 
                         t.date;
        
        // Tags
        let tagsHTML = '';
        if (t.tags && t.tags.length > 0 && allTags) {
            tagsHTML = t.tags.map(tagId => {
                const tag = allTags.find(tg => tg.id === tagId);
                return tag ? `<span class="tag-inline" style="color: ${tag.color};">#${tag.name}</span>` : '';
            }).join('');
        }
        
        // Subtasks progress
        let subtasksHTML = '';
        if (t.subtasks && t.subtasks.length > 0) {
            const done = t.subtasks.filter(s => s.done).length;
            const total = t.subtasks.length;
            subtasksHTML = `<span style="color: var(--cyan);">[${done}/${total}]</span>`;
        }
        
        return `
            <div class="task-item">
                <div class="task-priority ${t.priority}">${priorityChar}</div>
                <div class="task-content" onclick="App.editPlanTask('${t.id}')">
                    <div class="task-text">${this.esc(t.text)}${tagsHTML}</div>
                    <div class="task-meta">
                        <span>+${t.xp}XP</span>
                        ${subtasksHTML}
                        <span style="color: var(--cyan);">${dateLabel}</span>
                    </div>
                </div>
                <button class="task-delete" onclick="App.delTask('${t.id}')">[DEL]</button>
            </div>
        `;
    }
    
    async getPlannedTasks() {
        const all = await this.dbAll('tasks');
        const today = this.today();
        return all.filter(t => t.date > today && !t.done).sort((a, b) => {
            return a.date.localeCompare(b.date);
        });
    }
    
    getTomorrow() {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        return d.toISOString().split('T')[0];
    }
    
    getWeekEnd() {
        const d = new Date();
        d.setDate(d.getDate() + 7);
        return d.toISOString().split('T')[0];
    }
    
    daysUntil(dateStr) {
        const target = new Date(dateStr);
        const today = new Date(this.today());
        const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        return diff;
    }
    
    formatDate(dateStr) {
        const d = new Date(dateStr);
        const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        return `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`;
    }
    
    async addPlanTask() {
        const tomorrow = this.getTomorrow();
        const tagsHTML = await this.renderTagSelector([]);
        
        this.showModal('SCHEDULE TASK', `
            <div class="form-group">
                <label class="form-label">DESCRIPTION:</label>
                <input type="text" class="input" id="taskInput" placeholder="ENTER TASK...">
            </div>
            
            <div class="form-group">
                <label class="form-label">DATE:</label>
                <input type="date" class="input" id="planDate" value="${tomorrow}" min="${tomorrow}">
            </div>
            
            <div class="form-group">
                <label class="form-label">TAGS:</label>
                <div class="tags-row" id="tagsSelector">${tagsHTML}</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn active" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn active" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn" data-xp="20" onclick="App.setXP(20)">+20</button>
                    <button class="select-btn" data-xp="50" onclick="App.setXP(50)">+50</button>
                </div>
            </div>
            
            <button class="btn-submit" onclick="App.savePlanTask()">[ENTER] SCHEDULE</button>
        `);
        
        this.selectedPriority = 'medium';
        this.selectedXP = 10;
        this.selectedTags = [];
    }
    
    async savePlanTask() {
        const text = document.getElementById('taskInput').value.trim();
        const date = document.getElementById('planDate').value;
        if (!text || !date) return;
        
        const task = {
            id: Date.now().toString(),
            text: text,
            date: date,
            priority: this.selectedPriority,
            xp: this.selectedXP,
            done: false,
            tags: [...this.selectedTags],
            subtasks: []
        };
        
        await this.dbPut('tasks', task);
        this.closeModal();
        this.toast('TASK SCHEDULED FOR ' + this.formatDate(date));
        this.render();
    }
    
    async editPlanTask(id) {
        const task = await this.dbGet('tasks', id);
        if (!task) return;
        
        const tagsHTML = await this.renderTagSelector(task.tags || []);
        const subtasks = task.subtasks || [];
        const subtasksListHTML = subtasks.map((s, i) => `
            <div class="subtask-item">
                <button class="subtask-checkbox" onclick="App.toggleSubtask('${task.id}', ${i}); App.editPlanTask('${task.id}');">
                    ${s.done ? 'X' : ' '}
                </button>
                <span class="subtask-text ${s.done ? 'done' : ''}">${this.esc(s.text)}</span>
                <span class="subtask-del" onclick="App.delSubtask('${task.id}', ${i}); App.editPlanTask('${task.id}');">[X]</span>
            </div>
        `).join('');
        
        this.showModal('EDIT SCHEDULED TASK', `
            <div class="form-group">
                <label class="form-label">DESCRIPTION:</label>
                <input type="text" class="input" id="editInput" value="${this.esc(task.text)}">
            </div>
            
            <div class="form-group">
                <label class="form-label">DATE:</label>
                <input type="date" class="input" id="editDate" value="${task.date}">
            </div>
            
            <div class="form-group">
                <label class="form-label">TAGS:</label>
                <div class="tags-row" id="tagsSelector">${tagsHTML}</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">SUBTASKS:</label>
                ${subtasks.length > 0 ? `
                    <div class="subtasks-list" style="border: none; padding: 0;">
                        ${subtasksListHTML}
                    </div>
                ` : '<div style="font-size: 6px; color: var(--green-dim);">NO SUBTASKS</div>'}
                <div class="add-subtask-row">
                    <input type="text" class="input" id="subtaskInput-${task.id}" placeholder="ADD SUBTASK...">
                    <button class="btn-submit" style="width: auto; padding: 4px 12px;" onclick="App.addSubtask('${task.id}'); App.editPlanTask('${task.id}');">[+]</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn ${task.priority === 'low' ? 'active' : ''}" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn ${task.priority === 'medium' ? 'active' : ''}" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn ${task.priority === 'high' ? 'active' : ''}" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn ${task.xp === 5 ? 'active' : ''}" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn ${task.xp === 10 ? 'active' : ''}" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn ${task.xp === 20 ? 'active' : ''}" data-xp="20" onclick="App.setXP(20)">+20</button>
                    <button class="select-btn ${task.xp === 50 ? 'active' : ''}" data-xp="50" onclick="App.setXP(50)">+50</button>
                </div>
            </div>
            
            <button class="btn-submit" onclick="App.updatePlanTask('${task.id}')">[ENTER] UPDATE</button>
        `);
        
        this.selectedPriority = task.priority;
        this.selectedXP = task.xp;
        this.selectedTags = [...(task.tags || [])];
    }
    
    async updatePlanTask(id) {
        const task = await this.dbGet('tasks', id);
        if (!task) return;
        
        task.text = document.getElementById('editInput').value.trim();
        task.date = document.getElementById('editDate').value;
        task.priority = this.selectedPriority;
        task.xp = this.selectedXP;
        task.tags = [...this.selectedTags];
        
        await this.dbPut('tasks', task);
        this.closeModal();
        this.toast('TASK RESCHEDULED');
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderSys() {
        const all = await this.dbAll('tasks');
        const done = all.filter(t => t.done);
        const totalXP = (this.user.level - 1) * this.XP_MAX + this.user.xp;
        const tags = await this.getTags();
        const achStats = this.getAchievementStats();
        
        const hi = done.filter(t => t.priority === 'high').length;
        const med = done.filter(t => t.priority === 'medium').length;
        const lo = done.filter(t => t.priority === 'low').length;
        
        // Achievements grid
        const achievementsHTML = this.ACHIEVEMENTS.map(ach => {
            const unlocked = this.user.achievements && this.user.achievements.includes(ach.id);
            return `
                <div class="achievement-card ${unlocked ? 'unlocked' : 'locked'}">
                    <div class="achievement-card-icon">${ach.icon}</div>
                    <div class="achievement-card-name">${ach.name}</div>
                </div>
            `;
        }).join('');
        
        this.dom.content.innerHTML = `
            <div class="dos-box">
                <div class="dos-box-title">‚ïî‚ïê‚ïê PLAYER STATS ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-value">${String(this.user.level).padStart(2, '0')}</div>
                            <div class="stat-label">LEVEL</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${totalXP}</div>
                            <div class="stat-label">TOTAL XP</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${this.user.streak}</div>
                            <div class="stat-label">STREAK</div>
                        </div>
                    </div>
                    <div class="stats-row" style="margin-top: 8px;">
                        <div class="stat-box">
                            <div class="stat-value">${this.user.total}</div>
                            <div class="stat-label">COMPLETED</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${this.user.bossWins || 0}</div>
                            <div class="stat-label">BOSS WINS</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${all.length ? Math.round((done.length / all.length) * 100) : 0}%</div>
                            <div class="stat-label">RATE</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title" style="color: var(--amber);">‚ïî‚ïê‚ïê ‚òÖ ACHIEVEMENTS ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div style="font-size: 6px; color: var(--amber); margin-bottom: 8px;">
                        UNLOCKED: ${achStats.unlocked}/${achStats.total} (${achStats.percent}%)
                    </div>
                    <div class="achievements-grid">
                        ${achievementsHTML}
                    </div>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title">‚ïî‚ïê‚ïê TAGS ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div class="tags-row" style="margin-bottom: 8px;">
                        ${tags.length === 0 ? '<span style="font-size: 6px; color: var(--green-dim);">NO TAGS YET</span>' :
                        tags.map(t => `<span class="tag" style="border-color: ${t.color}; color: ${t.color};">#${t.name}</span>`).join('')}
                    </div>
                    <button class="btn-submit" style="font-size: 6px; padding: 6px;" onclick="App.showTagManager()">[+] MANAGE TAGS</button>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title">‚ïî‚ïê‚ïê SYSTEM CONFIG ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div class="settings-item" onclick="App.exportData()">
                        <span class="label">[1] EXPORT DATA</span>
                        <span class="arrow">‚ñ∫</span>
                    </div>
                    <div class="settings-item" onclick="App.importData()">
                        <span class="label">[2] IMPORT DATA</span>
                        <span class="arrow">‚ñ∫</span>
                    </div>
                    <div class="settings-item" onclick="App.resetProgress()">
                        <span class="label danger">[3] RESET PROGRESS</span>
                        <span class="arrow">‚ñ∫</span>
                    </div>
                    <div class="settings-item" onclick="App.clearAll()">
                        <span class="label danger">[4] FORMAT C:\\</span>
                        <span class="arrow">‚ñ∫</span>
                    </div>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title">‚ïî‚ïê‚ïê ABOUT ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content" style="font-size: 6px; color: var(--green-dim);">
                    TASK.SYS VERSION 1.1<br>
                    COPYRIGHT (C) 2025<br>
                    <br>
                    ALL RIGHTS RESERVED.<br>
                    <br>
                    "WAKE UP, NEO..."<br>
                    "THE MATRIX HAS YOU..."
                </div>
            </div>
        `;
        
        this.setStatus('SYSTEM', 'XP: ' + totalXP);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATS / ANALYTICS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderStats() {
        const tasks = await this.dbAll('tasks');
        const doneTasks = tasks.filter(t => t.done);
        
        // Calculate analytics
        const heatmap = this.calcHeatmap(doneTasks);
        const weeklyXP = this.calcWeeklyXP(doneTasks);
        const bestTime = this.calcBestTime(doneTasks);
        const monthlyXP = this.calcMonthlyXP(doneTasks);
        
        this.dom.content.innerHTML = `
            <div class="dos-box">
                <div class="dos-box-title" style="color: var(--cyan);">‚ïî‚ïê‚ïê üìä WEEKLY HEATMAP ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div style="font-size: 6px; color: var(--green-dim); margin-bottom: 8px;">
                        TASKS COMPLETED BY DAY OF WEEK
                    </div>
                    <pre style="font-family: 'Fira Code', monospace; font-size: 7px; line-height: 1.6; color: var(--green);">${heatmap.ascii}</pre>
                    <div style="font-size: 6px; color: var(--green-dim); margin-top: 8px;">
                        MOST ACTIVE: <span style="color: var(--amber);">${heatmap.bestDay}</span> (${heatmap.bestCount} TASKS)
                    </div>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title" style="color: var(--amber);">‚ïî‚ïê‚ïê üìà LAST 7 DAYS ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <pre style="font-family: 'Fira Code', monospace; font-size: 7px; line-height: 1.6; color: var(--green);">${weeklyXP.ascii}</pre>
                    <div style="font-size: 6px; color: var(--green-dim); margin-top: 8px;">
                        TOTAL: <span style="color: var(--amber);">${weeklyXP.total} XP</span> | AVG: <span style="color: var(--cyan);">${weeklyXP.avg} XP/DAY</span>
                    </div>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title" style="color: var(--magenta);">‚ïî‚ïê‚ïê üìâ LAST 30 DAYS ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <pre style="font-family: 'Fira Code', monospace; font-size: 9px; line-height: 1.4; color: var(--green); letter-spacing: 1px;">${monthlyXP.ascii}</pre>
                    <div style="font-size: 6px; color: var(--green-dim); margin-top: 8px;">
                        TOTAL: <span style="color: var(--amber);">${monthlyXP.total} XP</span> | AVG: <span style="color: var(--cyan);">${monthlyXP.avg} XP/DAY</span>
                    </div>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title" style="color: var(--green);">‚ïî‚ïê‚ïê ‚è∞ BEST TIME ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div style="font-size: 6px; color: var(--green-dim); margin-bottom: 8px;">
                        YOUR PRODUCTIVITY BY HOUR
                    </div>
                    <pre style="font-family: 'Fira Code', monospace; font-size: 7px; line-height: 1.6; color: var(--green);">${bestTime.ascii}</pre>
                    <div style="font-size: 7px; color: var(--green-dim); margin-top: 8px;">
                        PEAK HOURS: <span style="color: var(--amber);">${bestTime.peakHours}</span>
                    </div>
                    <div style="font-size: 6px; color: var(--cyan); margin-top: 4px;">
                        ${bestTime.recommendation}
                    </div>
                </div>
            </div>
            
            <div class="dos-box">
                <div class="dos-box-title">‚ïî‚ïê‚ïê SUMMARY ‚ïê‚ïê‚ïó</div>
                <div class="dos-box-content">
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-value">${doneTasks.length}</div>
                            <div class="stat-label">COMPLETED</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${tasks.length - doneTasks.length}</div>
                            <div class="stat-label">PENDING</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${tasks.length ? Math.round((doneTasks.length / tasks.length) * 100) : 0}%</div>
                            <div class="stat-label">RATE</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        this.setStatus('ANALYTICS', 'DATA LOADED');
    }
    
    calcHeatmap(tasks) {
        const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const counts = [0, 0, 0, 0, 0, 0, 0];
        
        tasks.forEach(t => {
            const d = new Date(t.date);
            counts[d.getDay()]++;
        });
        
        const max = Math.max(...counts, 1);
        let bestDay = 'N/A';
        let bestCount = 0;
        
        let ascii = '';
        days.forEach((day, i) => {
            const count = counts[i];
            const barLen = Math.round((count / max) * 30);
            const bar = '‚ñà'.repeat(barLen) + '‚ñë'.repeat(30 - barLen);
            ascii += `${day} [${bar}] ${count}\n`;
            
            if (count > bestCount) {
                bestCount = count;
                bestDay = day;
            }
        });
        
        return { ascii: ascii.trim(), bestDay, bestCount };
    }
    
    calcWeeklyXP(tasks) {
        const data = [];
        
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const dayName = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'][d.getDay()];
            
            const dayTasks = tasks.filter(t => t.date === dateStr);
            const xp = dayTasks.reduce((sum, t) => sum + (t.xp || 0), 0);
            
            data.push({ day: dayName, xp });
        }
        
        const max = Math.max(...data.map(d => d.xp), 1);
        const total = data.reduce((a, b) => a + b.xp, 0);
        const avg = Math.round(total / 7);
        
        // Build horizontal bar chart - wider bars
        let ascii = '';
        data.forEach(d => {
            const barLen = Math.round((d.xp / max) * 28);
            const bar = '‚ñà'.repeat(barLen) + '‚ñë'.repeat(28 - barLen);
            ascii += `${d.day} [${bar}] ${d.xp}\n`;
        });
        
        return { ascii: ascii.trim(), total, avg };
    }
    
    calcMonthlyXP(tasks) {
        const xpByDay = [];
        
        for (let i = 29; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            
            const dayTasks = tasks.filter(t => t.date === dateStr);
            const xp = dayTasks.reduce((sum, t) => sum + (t.xp || 0), 0);
            xpByDay.push(xp);
        }
        
        const max = Math.max(...xpByDay, 1);
        const total = xpByDay.reduce((a, b) => a + b, 0);
        const avg = Math.round(total / 30);
        
        // Sparkline style - use ¬∑ for zero instead of space
        const chars = ['¬∑', '‚ñÅ', '‚ñÇ', '‚ñÉ', '‚ñÑ', '‚ñÖ', '‚ñÜ', '‚ñá', '‚ñà'];
        let ascii = xpByDay.map(xp => {
            const idx = Math.round((xp / max) * 8);
            return chars[idx];
        }).join('');
        
        return { ascii, total, avg };
    }
    
    calcBestTime(tasks) {
        const hours = new Array(24).fill(0);
        
        tasks.forEach(t => {
            if (t.created) {
                const h = new Date(t.created).getHours();
                hours[h]++;
            }
        });
        
        const max = Math.max(...hours, 1);
        
        // Find peak hours
        const peaks = [];
        hours.forEach((count, h) => {
            if (count >= max * 0.7 && count > 0) {
                peaks.push(h);
            }
        });
        
        // Build hourly chart (compact - 6h blocks)
        const blocks = [
            { label: 'NIGHT', hours: [0, 1, 2, 3, 4, 5] },
            { label: 'MORNING', hours: [6, 7, 8, 9, 10, 11] },
            { label: 'AFTERNOON', hours: [12, 13, 14, 15, 16, 17] },
            { label: 'EVENING', hours: [18, 19, 20, 21, 22, 23] }
        ];
        
        let ascii = '';
        blocks.forEach(block => {
            const count = block.hours.reduce((sum, h) => sum + hours[h], 0);
            const barLen = Math.round((count / (max * 6)) * 26);
            const bar = '‚ñà'.repeat(Math.min(barLen, 26)) + '‚ñë'.repeat(Math.max(26 - barLen, 0));
            ascii += `${block.label.padEnd(9)} [${bar}] ${count}\n`;
        });
        
        // Detailed hour breakdown - 24h grid
        ascii += '\n';
        const chars = ['¬∑', '‚ñÇ', '‚ñÑ', '‚ñÜ', '‚ñà'];
        for (let h = 0; h < 24; h++) {
            const count = hours[h];
            const level = count === 0 ? 0 : Math.min(Math.ceil((count / max) * 4), 4);
            ascii += chars[level];
        }
        ascii += '\n0   4   8  12  16  20 23';
        
        const peakHours = peaks.length > 0 
            ? peaks.map(h => `${String(h).padStart(2, '0')}:00`).join(', ')
            : 'NOT ENOUGH DATA';
        
        let recommendation = '';
        if (peaks.length > 0) {
            const avgPeak = Math.round(peaks.reduce((a, b) => a + b, 0) / peaks.length);
            if (avgPeak < 12) {
                recommendation = '‚òÄ YOU ARE A MORNING PERSON! TACKLE HARD TASKS EARLY.';
            } else if (avgPeak < 18) {
                recommendation = 'üå§ AFTERNOON IS YOUR PRIME TIME. PLAN KEY WORK POST-LUNCH.';
            } else {
                recommendation = 'üåô NIGHT OWL DETECTED! YOUR BRAIN PEAKS IN THE EVENING.';
            }
        } else {
            recommendation = 'üìä COMPLETE MORE TASKS TO SEE YOUR PATTERNS!';
        }
        
        return { ascii: ascii.trim(), peakHours, recommendation };
    }
    
    async exportData() {
        this.setStatus('EXPORTING<span class="loading-dots"></span>');
        const tasks = await this.dbAll('tasks');
        const data = { user: this.user, tasks: tasks, date: new Date().toISOString() };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'tasksys_' + this.today() + '.json';
        a.click();
        
        this.toast('DATA EXPORTED TO FILE');
        this.setStatus('EXPORT COMPLETE');
    }
    
    importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            this.setStatus('IMPORTING<span class="loading-dots"></span>');
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (data.user) {
                    this.user = data.user;
                    await this.saveUser();
                }
                
                if (data.tasks) {
                    for (const t of data.tasks) {
                        await this.dbPut('tasks', t);
                    }
                }
                
                this.updateXP();
                this.toast('DATA IMPORTED SUCCESSFULLY');
                this.render();
            } catch (err) {
                this.toast('ERROR: INVALID FILE FORMAT', 'error');
            }
            
            this.setStatus('READY');
        };
        input.click();
    }
    
    async resetProgress() {
        this.showModal('WARNING', `
            <div style="font-size: 7px; color: var(--amber); margin-bottom: 16px; text-align: center;">
                ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó<br>
                ‚ïë  ! RESET PROGRESS !   ‚ïë<br>
                ‚ïë                       ‚ïë<br>
                ‚ïë  ALL XP WILL BE LOST  ‚ïë<br>
                ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            </div>
            <div class="select-row">
                <button class="btn-submit" style="border-color: var(--green-dim); color: var(--green-dim);" onclick="App.closeModal()">[N] CANCEL</button>
                <button class="btn-submit" style="border-color: var(--red); color: var(--red);" onclick="App.confirmReset()">[Y] CONFIRM</button>
            </div>
        `);
    }
    
    async confirmReset() {
        this.setStatus('RESETTING<span class="loading-dots"></span>');
        this.user = { 
            level: 1, 
            xp: 0, 
            total: 0, 
            streak: 0, 
            lastDate: this.today(),
            achievements: [],
            bossWins: 0
        };
        await this.saveUser();
        this.updateXP();
        this.closeModal();
        this.toast('PROGRESS RESET TO ZERO');
        this.render();
        this.setStatus('READY');
    }
    
    async clearAll() {
        this.showModal('DANGER', `
            <div style="font-size: 7px; color: var(--red); margin-bottom: 16px; text-align: center;">
                ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó<br>
                ‚ïë   !! FORMAT C:\\ !!    ‚ïë<br>
                ‚ïë                       ‚ïë<br>
                ‚ïë  ALL DATA WILL BE     ‚ïë<br>
                ‚ïë  PERMANENTLY DELETED  ‚ïë<br>
                ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            </div>
            <div class="select-row">
                <button class="btn-submit" style="border-color: var(--green-dim); color: var(--green-dim);" onclick="App.closeModal()">[N] ABORT</button>
                <button class="btn-submit" style="border-color: var(--red); color: var(--red);" onclick="App.confirmClearAll()">[Y] FORMAT</button>
            </div>
        `);
    }
    
    async confirmClearAll() {
        this.setStatus('FORMATTING<span class="loading-dots"></span>');
        await this.dbClear('tasks');
        await this.dbClear('tags');
        this.user = { 
            level: 1, 
            xp: 0, 
            total: 0, 
            streak: 0, 
            lastDate: this.today(),
            achievements: [],
            bossWins: 0
        };
        await this.saveUser();
        this.filterTag = null;
        this.updateXP();
        this.closeModal();
        this.render();
        this.toast('FORMAT COMPLETE');
        this.setStatus('READY');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    showModal(title, body) {
        this.dom.modalTitle.textContent = title;
        this.dom.modalBody.innerHTML = body;
        this.dom.modal.classList.add('active');
    }
    
    closeModal(e) {
        if (e && e.target !== this.dom.modal) return;
        this.dom.modal.classList.remove('active');
    }
    
    toast(msg, type) {
        type = type || 'success';
        this.dom.toast.textContent = msg;
        this.dom.toast.className = 'toast ' + type + ' show';
        setTimeout(() => this.dom.toast.classList.remove('show'), 2500);
    }
    
    showLevelUp(lvl) {
        this.dom.levelupNum.textContent = String(lvl).padStart(2, '0');
        this.dom.levelup.classList.add('active');
        this.playLevelUpSound();
        setTimeout(() => this.closeLevelUp(), 3000);
    }
    
    closeLevelUp() {
        this.dom.levelup.classList.remove('active');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 8-BIT AUDIO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    initAudio() {
        if (!this.audioCtx) {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        return this.audioCtx;
    }
    
    playNote(freq, duration, type = 'square', volume = 0.3) {
        try {
            const ctx = this.initAudio();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            
            gain.gain.setValueAtTime(volume, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + duration);
        } catch(e) {}
    }
    
    playLevelUpSound() {
        // 8-bit victory melody: C-E-G-C (arpeggio up)
        const melody = [
            { freq: 523, delay: 0 },      // C5
            { freq: 659, delay: 100 },    // E5
            { freq: 784, delay: 200 },    // G5
            { freq: 1047, delay: 300 },   // C6
            { freq: 1047, delay: 500 },   // C6 (repeat)
            { freq: 1175, delay: 600 },   // D6
            { freq: 1319, delay: 700 },   // E6
        ];
        
        melody.forEach(note => {
            setTimeout(() => this.playNote(note.freq, 0.15, 'square', 0.2), note.delay);
        });
    }
    
    playStaticSound() {
        try {
            const ctx = this.initAudio();
            const bufferSize = ctx.sampleRate * 0.1;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            const noise = ctx.createBufferSource();
            const gain = ctx.createGain();
            
            noise.buffer = buffer;
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            
            noise.connect(gain);
            gain.connect(ctx.destination);
            noise.start();
        } catch(e) {}
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATIC NOISE EFFECT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    showStaticNoise() {
        this.dom.staticNoise.classList.remove('active');
        void this.dom.staticNoise.offsetWidth; // Force reflow
        this.dom.staticNoise.classList.add('active');
        this.playStaticSound();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOSS MODE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    startBoss(task, minutes) {
        this.bossActive = true;
        this.bossTask = task;
        this.bossDuration = minutes * 60;
        this.bossTimeLeft = this.bossDuration;
        
        this.dom.bossTask.textContent = task.text;
        this.updateBossTimer();
        this.dom.bossOverlay.classList.add('active');
        
        this.bossTimer = setInterval(() => {
            this.bossTimeLeft--;
            this.updateBossTimer();
            
            if (this.bossTimeLeft <= 0) {
                this.bossFail();
            }
        }, 1000);
        
        this.setStatus('BOSS BATTLE!', 'FOCUS MODE');
    }
    
    updateBossTimer() {
        const mins = Math.floor(this.bossTimeLeft / 60);
        const secs = this.bossTimeLeft % 60;
        this.dom.bossTimerEl.textContent = 
            String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
        
        const pct = (this.bossTimeLeft / this.bossDuration) * 100;
        this.dom.bossProgressFill.style.width = pct + '%';
        
        // Color changes
        const timerEl = this.dom.bossTimerEl;
        const fillEl = this.dom.bossProgressFill;
        
        timerEl.classList.remove('warning', 'danger');
        fillEl.classList.remove('warning', 'danger');
        
        if (pct <= 20) {
            timerEl.classList.add('danger');
            fillEl.classList.add('danger');
        } else if (pct <= 50) {
            timerEl.classList.add('warning');
            fillEl.classList.add('warning');
        }
    }
    
    async bossWin() {
        clearInterval(this.bossTimer);
        this.bossActive = false;
        
        // Mark task as done with DOUBLE XP
        const task = this.bossTask;
        task.done = true;
        await this.dbPut('tasks', task);
        
        const bonusXP = task.xp * 2;
        this.user.total++;
        this.user.bossWins = (this.user.bossWins || 0) + 1;
        await this.addXP(bonusXP);
        
        this.dom.bossOverlay.classList.remove('active');
        this.toast('BOSS DEFEATED! +' + bonusXP + ' XP (2X BONUS!)');
        await this.checkAchievements();
        this.render();
        this.setStatus('VICTORY!', 'BOSS DEFEATED');
    }
    
    bossFail() {
        clearInterval(this.bossTimer);
        this.bossActive = false;
        
        this.dom.bossOverlay.classList.remove('active');
        this.toast('BOSS ESCAPED! NO XP EARNED', 'error');
        this.render();
        this.setStatus('DEFEAT...', 'TRY AGAIN');
    }
    
    showBossModal(task) {
        this.showModal('‚ò† BOSS BATTLE ‚ò†', `
            <div style="font-size: 7px; color: var(--amber); margin-bottom: 16px; text-align: center;">
                ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó<br>
                ‚ïë   FOCUS MODE ACTIVE   ‚ïë<br>
                ‚ïë                       ‚ïë<br>
                ‚ïë  COMPLETE THE TASK    ‚ïë<br>
                ‚ïë  BEFORE TIME RUNS OUT ‚ïë<br>
                ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            </div>
            <div style="font-size: 6px; color: var(--green); margin-bottom: 16px; text-align: center;">
                ${this.esc(task.text)}
            </div>
            <div class="form-group">
                <label class="form-label">SELECT TIME:</label>
                <div class="select-row">
                    <button class="select-btn" data-time="15" onclick="App.setBossTime(15)">15M</button>
                    <button class="select-btn active" data-time="30" onclick="App.setBossTime(30)">30M</button>
                    <button class="select-btn" data-time="45" onclick="App.setBossTime(45)">45M</button>
                    <button class="select-btn" data-time="60" onclick="App.setBossTime(60)">60M</button>
                </div>
            </div>
            <div style="font-size: 6px; color: var(--amber); margin-bottom: 16px; text-align: center;">
                ‚òÖ REWARD: ${task.xp * 2} XP (2X BONUS!) ‚òÖ
            </div>
            <div class="select-row">
                <button class="btn-submit" style="border-color: var(--green-dim); color: var(--green-dim);" onclick="App.closeModal()">[ESC] CANCEL</button>
                <button class="btn-submit" style="border-color: var(--amber); color: var(--amber);" onclick="App.closeModal(); App.startBoss(App.pendingBossTask, App.selectedBossTime)">START!</button>
            </div>
        `);
        this.pendingBossTask = task;
        this.selectedBossTime = 30;
    }
    
    setBossTime(mins) {
        this.selectedBossTime = mins;
        document.querySelectorAll('[data-time]').forEach(b => {
            b.classList.toggle('active', parseInt(b.dataset.time) === mins);
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACHIEVEMENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async checkAchievements() {
        const newAchievements = [];
        
        for (const ach of this.ACHIEVEMENTS) {
            if (!this.user.achievements.includes(ach.id) && ach.check(this.user)) {
                this.user.achievements.push(ach.id);
                newAchievements.push(ach);
            }
        }
        
        await this.saveUser();
        
        // Show achievements one by one
        for (const ach of newAchievements) {
            await this.showAchievement(ach);
        }
    }
    
    showAchievement(ach) {
        return new Promise(resolve => {
            this.dom.achievementIcon.textContent = ach.icon;
            this.dom.achievementName.textContent = ach.name;
            this.dom.achievementDesc.textContent = ach.desc;
            this.dom.achievementOverlay.classList.add('active');
            
            this.playAchievementSound();
            
            const handler = () => {
                document.removeEventListener('click', handler);
                document.removeEventListener('keydown', handler);
                this.closeAchievement();
                resolve();
            };
            
            setTimeout(() => {
                document.addEventListener('click', handler);
                document.addEventListener('keydown', handler);
            }, 500);
        });
    }
    
    closeAchievement() {
        this.dom.achievementOverlay.classList.remove('active');
    }
    
    playAchievementSound() {
        const melody = [
            { freq: 659, delay: 0 },      // E5
            { freq: 784, delay: 100 },    // G5
            { freq: 1047, delay: 200 },   // C6
            { freq: 1319, delay: 300 },   // E6
            { freq: 1568, delay: 400 },   // G6
        ];
        
        melody.forEach(note => {
            setTimeout(() => this.playNote(note.freq, 0.2, 'square', 0.15), note.delay);
        });
    }
    
    getAchievementStats() {
        const unlocked = this.user.achievements.length;
        const total = this.ACHIEVEMENTS.length;
        return { unlocked, total, percent: Math.round((unlocked / total) * 100) };
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TAGS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async getTags() {
        return await this.dbAll('tags');
    }
    
    async saveTag(name, color) {
        const tag = {
            id: Date.now().toString(),
            name: name.toUpperCase(),
            color: color || '#00ffff'
        };
        await this.dbPut('tags', tag);
        return tag;
    }
    
    async deleteTag(id) {
        await this.dbDel('tags', id);
        // Remove tag from all tasks
        const tasks = await this.dbAll('tasks');
        for (const task of tasks) {
            if (task.tags && task.tags.includes(id)) {
                task.tags = task.tags.filter(t => t !== id);
                await this.dbPut('tasks', task);
            }
        }
    }
    
    async showTagManager() {
        const tags = await this.getTags();
        
        this.showModal('MANAGE TAGS', `
            <div class="form-group">
                <label class="form-label">YOUR TAGS:</label>
                <div class="tags-list" style="margin-bottom: 12px;">
                    ${tags.length === 0 ? '<div style="font-size: 6px; color: var(--green-dim);">NO TAGS YET</div>' : 
                    tags.map(t => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--green-dark);">
                            <span class="tag" style="border-color: ${t.color}; color: ${t.color};">#${t.name}</span>
                            <button onclick="App.confirmDeleteTag('${t.id}')" style="font-size: 6px; color: var(--red); background: none; border: none; cursor: pointer;">[DEL]</button>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ADD NEW TAG:</label>
                <div class="add-subtask-row">
                    <input type="text" class="input" id="newTagName" placeholder="TAG NAME..." maxlength="15">
                    <button class="btn-submit" style="width: auto; padding: 4px 12px;" onclick="App.createTag()">[+]</button>
                </div>
            </div>
            
            <button class="btn-submit" onclick="App.closeModal()">[ESC] CLOSE</button>
        `);
    }
    
    async createTag() {
        const name = document.getElementById('newTagName').value.trim();
        if (!name) return;
        
        const colors = ['#00ffff', '#ff00ff', '#ffff00', '#ff6600', '#00ff00'];
        const tags = await this.getTags();
        const color = colors[tags.length % colors.length];
        
        await this.saveTag(name, color);
        this.toast('TAG CREATED: #' + name.toUpperCase());
        this.showTagManager();
    }
    
    async confirmDeleteTag(id) {
        await this.deleteTag(id);
        this.toast('TAG DELETED');
        this.showTagManager();
    }
    
    async renderTagSelector(selectedTags = []) {
        const tags = await this.getTags();
        if (tags.length === 0) return '<div style="font-size: 6px; color: var(--green-dim);">NO TAGS. <a href="#" onclick="App.closeModal(); App.showTagManager(); return false;" style="color: var(--cyan);">CREATE SOME</a></div>';
        
        return tags.map(t => `
            <span class="tag ${selectedTags.includes(t.id) ? 'selected' : ''}" 
                  style="border-color: ${t.color}; color: ${selectedTags.includes(t.id) ? 'var(--bg)' : t.color}; background: ${selectedTags.includes(t.id) ? t.color : 'transparent'};"
                  onclick="App.toggleTagSelection('${t.id}')">#${t.name}</span>
        `).join('');
    }
    
    toggleTagSelection(tagId) {
        if (this.selectedTags.includes(tagId)) {
            this.selectedTags = this.selectedTags.filter(t => t !== tagId);
        } else {
            this.selectedTags.push(tagId);
        }
        
        // Update visual
        document.querySelectorAll('.tag[onclick*="toggleTagSelection"]').forEach(async el => {
            const id = el.getAttribute('onclick').match(/'([^']+)'/)[1];
            const tags = await this.getTags();
            const tag = tags.find(t => t.id === id);
            if (!tag) return;
            
            if (this.selectedTags.includes(id)) {
                el.classList.add('selected');
                el.style.background = tag.color;
                el.style.color = 'var(--bg)';
            } else {
                el.classList.remove('selected');
                el.style.background = 'transparent';
                el.style.color = tag.color;
            }
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUBTASKS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async toggleSubtask(taskId, subtaskIndex) {
        const task = await this.dbGet('tasks', taskId);
        if (!task || !task.subtasks) return;
        
        task.subtasks[subtaskIndex].done = !task.subtasks[subtaskIndex].done;
        await this.dbPut('tasks', task);
        
        // Check if all subtasks done
        const allDone = task.subtasks.every(s => s.done);
        if (allDone && !task.done) {
            this.toast('ALL SUBTASKS COMPLETE! MARK TASK AS DONE?');
        }
        
        this.render();
    }
    
    async addSubtask(taskId) {
        const input = document.getElementById('subtaskInput-' + taskId);
        if (!input) return;
        
        const text = input.value.trim();
        if (!text) return;
        
        const task = await this.dbGet('tasks', taskId);
        if (!task) return;
        
        if (!task.subtasks) task.subtasks = [];
        task.subtasks.push({ text, done: false });
        
        await this.dbPut('tasks', task);
        input.value = '';
        this.render();
    }
    
    async delSubtask(taskId, subtaskIndex) {
        const task = await this.dbGet('tasks', taskId);
        if (!task || !task.subtasks) return;
        
        task.subtasks.splice(subtaskIndex, 1);
        await this.dbPut('tasks', task);
        this.render();
    }
    
    renderSubtasks(task) {
        if (!task.subtasks || task.subtasks.length === 0) return '';
        
        const done = task.subtasks.filter(s => s.done).length;
        const total = task.subtasks.length;
        
        return `
            <div class="subtasks-list">
                ${task.subtasks.map((s, i) => `
                    <div class="subtask-item">
                        <button class="subtask-checkbox" onclick="event.stopPropagation(); App.toggleSubtask('${task.id}', ${i})">
                            ${s.done ? 'X' : ' '}
                        </button>
                        <span class="subtask-text ${s.done ? 'done' : ''}">${this.esc(s.text)}</span>
                        <span class="subtask-del" onclick="event.stopPropagation(); App.delSubtask('${task.id}', ${i})">[X]</span>
                    </div>
                `).join('')}
                <div class="subtask-progress">${done}/${total} SUBTASKS</div>
            </div>
        `;
    }
    
    esc(txt) {
        const d = document.createElement('div');
        d.textContent = txt;
        return d.innerHTML;
    }
}

// START
const App = new TaskSys();
document.addEventListener('DOMContentLoaded', () => App.boot());
window.App = App;
</script>
</body>
</html>
